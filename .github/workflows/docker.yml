name: Docker

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: b1e55ed:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test image can run
        run: |
          docker run --rm b1e55ed:test b1e55ed --help
          docker run --rm b1e55ed:test python -c "import engine; print('✅ Engine imports')"
      
      - name: Check image size
        run: |
          SIZE=$(docker images b1e55ed:test --format "{{.Size}}")
          echo "Image size: $SIZE"
          # Warn if >500MB (should be ~200-300MB)
          SIZE_MB=$(docker images b1e55ed:test --format "{{.Size}}" | sed 's/MB//' | cut -d'.' -f1)
          if [ "$SIZE_MB" -gt 500 ]; then
            echo "⚠️  Image size >500MB - consider optimization"
          fi
  
  compose:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate docker-compose.yml
        run: docker-compose config -q
      
      - name: Test docker-compose up
        run: |
          # Create minimal .env
          cat > .env << EOF
          B1E55ED_MASTER_PASSWORD=test-password-ci
          B1E55ED_EXECUTION__MODE=paper
          EOF
          
          # Build and start (detached)
          docker-compose build
          docker-compose up -d
          
          # Wait for services
          sleep 10
          
          # Check health
          curl -f http://localhost:5050/health || (docker-compose logs && exit 1)
          
          # Cleanup
          docker-compose down -v
  
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'Dockerfile'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
